"use strict";var e=require("../../logger-04bad527.cjs"),t=require("../../session-ef1ef979.cjs"),s=require("@aws-sdk/client-rds-data"),r=require("../../index-59b7992d.cjs"),n=require("../../utils-9d882195.cjs");function i(e){return"date"===e?s.TypeHint.DATE:"decimal"===e?s.TypeHint.DECIMAL:"json"===e?s.TypeHint.JSON:"time"===e?s.TypeHint.TIME:"timestamp"===e?s.TypeHint.TIMESTAMP:"uuid"===e?s.TypeHint.UUID:void 0}function a(e,t){const s={value:{},typeHint:i(t)};if(null===e)s.value={isNull:!0};else if("string"==typeof e)s.value="DATE"===s.typeHint?{stringValue:e.split("T")[0]}:{stringValue:e};else if("number"==typeof e&&Number.isInteger(e))s.value={longValue:e};else if("number"!=typeof e||Number.isInteger(e))if("boolean"==typeof e)s.value={booleanValue:e};else{if(!(e instanceof Date))throw new Error(`Unknown type for ${e}`);s.value={stringValue:e.toISOString().replace("T"," ").replace("Z","")}}else s.value={doubleValue:e};return s}require("../../query-promise-2c5b43ab.cjs"),require("../../query-builder-2f2e8229.cjs"),require("../../column-builder-b48639f3.cjs");class o extends t.PreparedQuery{constructor(e,t,r,n,i,a,o){super(),this.client=e,this.params=r,this.typings=n,this.options=i,this.fields=a,this.transactionId=o,this.rawQuery=new s.ExecuteStatementCommand({sql:t,parameters:[],secretArn:i.secretArn,resourceArn:i.resourceArn,database:i.database,transactionId:o})}async execute(e={}){const t=r.fillPlaceholders(this.params,e);this.rawQuery.input.parameters=t.map(((e,t)=>({name:`${t+1}`,...a(e,this.typings[t])}))),this.options.logger?.logQuery(this.rawQuery.input.sql,this.rawQuery.input.parameters);const{fields:s,rawQuery:i,client:o,joinsNotNullableMap:l}=this;if(!s){return(await o.send(i)).records??[]}const u=await o.send(i);return u.records?.map((e=>{const t=e.map((e=>function(e){if(void 0!==e.stringValue)return e.stringValue;if(void 0!==e.booleanValue)return e.booleanValue;if(void 0!==e.doubleValue)return e.doubleValue;if(void 0!==e.isNull)return null;if(void 0!==e.longValue)return e.longValue;if(void 0!==e.blobValue)return e.blobValue;if(void 0!==e.arrayValue){if(void 0!==e.arrayValue.stringValues)return e.arrayValue.stringValues;throw new Error("Unknown array type")}throw new Error("Unknown type")}(e)));return n.mapResultRow(s,t,l)}))}all(e){return this.execute(e)}}class l extends t.PgSession{constructor(e,t,s,r){super(t),this.client=e,this.options=s,this.transactionId=r,this.rawQuery={secretArn:s.secretArn,resourceArn:s.resourceArn,database:s.database}}prepareQuery(e,t,s){return new o(this.client,e.sql,e.params,e.typings??[],this.options,t,s)}execute(e){return this.prepareQuery(this.dialect.sqlToQuery(e),void 0,this.transactionId).execute()}async transaction(e,t){const{transactionId:r}=await this.client.send(new s.BeginTransactionCommand(this.rawQuery)),n=new l(this.client,this.dialect,this.options,r),i=new u(this.dialect,n);t&&await i.setTransaction(t);try{const t=await e(i);return await this.client.send(new s.CommitTransactionCommand({...this.rawQuery,transactionId:r})),t}catch(e){throw await this.client.send(new s.RollbackTransactionCommand({...this.rawQuery,transactionId:r})),e}}}class u extends t.PgTransaction{transaction(e){const t=`sp${this.nestedIndex+1}`,s=new u(this.dialect,this.session,this.nestedIndex+1);this.session.execute(r.sql`savepoint ${t}`);try{const n=e(s);return this.session.execute(r.sql`release savepoint ${t}`),n}catch(e){throw this.session.execute(r.sql`rollback to savepoint ${t}`),e}}}class c{constructor(e,t,s){this.client=e,this.dialect=t,this.options=s}createSession(){return new l(this.client,this.dialect,this.options,void 0)}}class p extends t.PgDialect{escapeName(e){return`"${e}"`}escapeParam(e){return`:${e+1}`}}exports.AwsDataApiDriver=c,exports.AwsDataApiPreparedQuery=o,exports.AwsDataApiSession=l,exports.AwsDataApiTransaction=u,exports.AwsPgDialect=p,exports.drizzle=function(s,r){const n=new p;let i;!0===r.logger?i=new e.DefaultLogger:!1!==r.logger&&(i=r.logger);const a=new c(s,n,{...r,logger:i}).createSession();return new t.PgDatabase(n,a)};
//# sourceMappingURL=index.cjs.map
