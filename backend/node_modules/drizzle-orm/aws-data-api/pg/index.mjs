import{D as e}from"../../logger-2598bf05.mjs";import{P as t,a as s,b as r,c as n,d as i}from"../../session-c891400d.mjs";import{TypeHint as a,ExecuteStatementCommand as o,BeginTransactionCommand as l,CommitTransactionCommand as u,RollbackTransactionCommand as c}from"@aws-sdk/client-rds-data";import{k as d,s as p}from"../../index-b71998f1.mjs";import{m as h}from"../../utils-e6870670.mjs";import"../../query-promise-a65edd44.mjs";import"../../query-builder-2fcde2f0.mjs";import"../../column-builder-592f0191.mjs";function m(e){return"date"===e?a.DATE:"decimal"===e?a.DECIMAL:"json"===e?a.JSON:"time"===e?a.TIME:"timestamp"===e?a.TIMESTAMP:"uuid"===e?a.UUID:void 0}function w(e,t){const s={value:{},typeHint:m(t)};if(null===e)s.value={isNull:!0};else if("string"==typeof e)s.value="DATE"===s.typeHint?{stringValue:e.split("T")[0]}:{stringValue:e};else if("number"==typeof e&&Number.isInteger(e))s.value={longValue:e};else if("number"!=typeof e||Number.isInteger(e))if("boolean"==typeof e)s.value={booleanValue:e};else{if(!(e instanceof Date))throw new Error(`Unknown type for ${e}`);s.value={stringValue:e.toISOString().replace("T"," ").replace("Z","")}}else s.value={doubleValue:e};return s}class y extends t{constructor(e,t,s,r,n,i,a){super(),this.client=e,this.params=s,this.typings=r,this.options=n,this.fields=i,this.transactionId=a,this.rawQuery=new o({sql:t,parameters:[],secretArn:n.secretArn,resourceArn:n.resourceArn,database:n.database,transactionId:a})}async execute(e={}){const t=d(this.params,e);this.rawQuery.input.parameters=t.map(((e,t)=>({name:`${t+1}`,...w(e,this.typings[t])}))),this.options.logger?.logQuery(this.rawQuery.input.sql,this.rawQuery.input.parameters);const{fields:s,rawQuery:r,client:n,joinsNotNullableMap:i}=this;if(!s){return(await n.send(r)).records??[]}const a=await n.send(r);return a.records?.map((e=>{const t=e.map((e=>function(e){if(void 0!==e.stringValue)return e.stringValue;if(void 0!==e.booleanValue)return e.booleanValue;if(void 0!==e.doubleValue)return e.doubleValue;if(void 0!==e.isNull)return null;if(void 0!==e.longValue)return e.longValue;if(void 0!==e.blobValue)return e.blobValue;if(void 0!==e.arrayValue){if(void 0!==e.arrayValue.stringValues)return e.arrayValue.stringValues;throw new Error("Unknown array type")}throw new Error("Unknown type")}(e)));return h(s,t,i)}))}all(e){return this.execute(e)}}class f extends s{constructor(e,t,s,r){super(t),this.client=e,this.options=s,this.transactionId=r,this.rawQuery={secretArn:s.secretArn,resourceArn:s.resourceArn,database:s.database}}prepareQuery(e,t,s){return new y(this.client,e.sql,e.params,e.typings??[],this.options,t,s)}execute(e){return this.prepareQuery(this.dialect.sqlToQuery(e),void 0,this.transactionId).execute()}async transaction(e,t){const{transactionId:s}=await this.client.send(new l(this.rawQuery)),r=new f(this.client,this.dialect,this.options,s),n=new g(this.dialect,r);t&&await n.setTransaction(t);try{const t=await e(n);return await this.client.send(new u({...this.rawQuery,transactionId:s})),t}catch(e){throw await this.client.send(new c({...this.rawQuery,transactionId:s})),e}}}class g extends r{transaction(e){const t=`sp${this.nestedIndex+1}`,s=new g(this.dialect,this.session,this.nestedIndex+1);this.session.execute(p`savepoint ${t}`);try{const r=e(s);return this.session.execute(p`release savepoint ${t}`),r}catch(e){throw this.session.execute(p`rollback to savepoint ${t}`),e}}}class b{constructor(e,t,s){this.client=e,this.dialect=t,this.options=s}createSession(){return new f(this.client,this.dialect,this.options,void 0)}}class v extends n{escapeName(e){return`"${e}"`}escapeParam(e){return`:${e+1}`}}function V(t,s){const r=new v;let n;!0===s.logger?n=new e:!1!==s.logger&&(n=s.logger);const a=new b(t,r,{...s,logger:n}).createSession();return new i(r,a)}export{b as AwsDataApiDriver,y as AwsDataApiPreparedQuery,f as AwsDataApiSession,g as AwsDataApiTransaction,v as AwsPgDialect,V as drizzle};
//# sourceMappingURL=index.mjs.map
