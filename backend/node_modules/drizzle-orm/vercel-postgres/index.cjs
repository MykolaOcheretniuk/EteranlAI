"use strict";var e=require("../logger-04bad527.cjs"),t=require("@vercel/postgres"),r=require("../index-59b7992d.cjs"),s=require("../session-ef1ef979.cjs"),i=require("../utils-9d882195.cjs");require("../query-promise-2c5b43ab.cjs"),require("../query-builder-2f2e8229.cjs"),require("../column-builder-b48639f3.cjs");class a extends s.PreparedQuery{constructor(e,t,r,s,i,a){super(),this.client=e,this.params=r,this.logger=s,this.fields=i,this.rawQuery={name:a,text:t},this.query={name:a,text:t,rowMode:"array"}}execute(e={}){const t=r.fillPlaceholders(this.params,e);this.logger.logQuery(this.rawQuery.text,t);const{fields:s,rawQuery:a,client:n,query:o,joinsNotNullableMap:l}=this;if(!s)return n.query(a,t);return n.query(o,t).then((e=>e.rows.map((e=>i.mapResultRow(s,e,l)))))}all(e={}){const t=r.fillPlaceholders(this.params,e);return this.logger.logQuery(this.rawQuery.text,t),this.client.query(this.rawQuery,t).then((e=>e.rows))}values(e={}){const t=r.fillPlaceholders(this.params,e);return this.logger.logQuery(this.rawQuery.text,t),this.client.query(this.query,t).then((e=>e.rows))}}class n extends s.PgSession{constructor(t,r,s={}){super(r),this.client=t,this.options=s,this.logger=s.logger??new e.NoopLogger}prepareQuery(e,t,r){return new a(this.client,e.sql,e.params,this.logger,t,r)}async query(e,t){this.logger.logQuery(e,t);return await this.client.query({rowMode:"array",text:e,values:t})}async queryObjects(e,t){return this.client.query(e,t)}async transaction(e,s){const i=this.client instanceof t.VercelPool?new n(await this.client.connect(),this.dialect,this.options):this,a=new o(this.dialect,i);await a.execute(r.sql`begin${s?r.sql` ${a.getTransactionConfigSQL(s)}`:void 0}`);try{const t=await e(a);return await a.execute(r.sql`commit`),t}catch(e){throw await a.execute(r.sql`rollback`),e}finally{this.client instanceof t.VercelPool&&i.client.release()}}}class o extends s.PgTransaction{async transaction(e){const t=`sp${this.nestedIndex+1}`,s=new o(this.dialect,this.session,this.nestedIndex+1);await s.execute(r.sql.raw(`savepoint ${t}`));try{const i=await e(s);return await s.execute(r.sql.raw(`release savepoint ${t}`)),i}catch(e){throw await s.execute(r.sql.raw(`rollback to savepoint ${t}`)),e}}}class l{constructor(e,t,r={}){this.client=e,this.dialect=t,this.options=r,this.initMappers()}createSession(){return new n(this.client,this.dialect,{logger:this.options.logger})}initMappers(){}}exports.VercelPgDriver=l,exports.VercelPgPreparedQuery=a,exports.VercelPgSession=n,exports.VercelPgTransaction=o,exports.drizzle=function(t,r={}){const i=new s.PgDialect;let a;!0===r.logger?a=new e.DefaultLogger:!1!==r.logger&&(a=r.logger);const n=new l(t,i,{logger:a}).createSession();return new s.PgDatabase(i,n)};
//# sourceMappingURL=index.cjs.map
