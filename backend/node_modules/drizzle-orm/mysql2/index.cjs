"use strict";var e=require("../logger-04bad527.cjs"),t=require("../session-e6db6732.cjs"),s=require("node:events"),r=require("../index-59b7992d.cjs"),i=require("../utils-9d882195.cjs");require("../query-promise-2c5b43ab.cjs"),require("../column-builder-b48639f3.cjs"),require("../query-builder-2f2e8229.cjs");class n extends t.PreparedQuery{constructor(e,t,s,r,i){super(),this.client=e,this.params=s,this.logger=r,this.fields=i,this.rawQuery={sql:t,typeCast:function(e,t){return"TIMESTAMP"===e.type||"DATETIME"===e.type||"DATE"===e.type?e.string():t()}},this.query={sql:t,rowsAsArray:!0,typeCast:function(e,t){return"TIMESTAMP"===e.type||"DATETIME"===e.type||"DATE"===e.type?e.string():t()}}}async execute(e={}){const t=r.fillPlaceholders(this.params,e);this.logger.logQuery(this.rawQuery.sql,t);const{fields:s,client:n,rawQuery:a,query:o,joinsNotNullableMap:l}=this;if(!s)return n.query(a,t);return n.query(o,t).then((e=>e[0].map((e=>i.mapResultRow(s,e,l)))))}async*iterator(e={}){const t=r.fillPlaceholders(this.params,e),n=(l(this.client)?await this.client.getConnection():this.client).connection,{fields:a,query:o,rawQuery:c,joinsNotNullableMap:u,client:y}=this,h=(a?n.query(o,t):n.query(c,t)).stream();function p(){h.pause()}h.on("data",p);try{const e=s.once(h,"end"),t=s.once(h,"error");for(;;){h.resume();const s=await Promise.race([e,t,new Promise((e=>h.once("data",e)))]);if(void 0===s||Array.isArray(s)&&0===s.length)break;if(s instanceof Error)throw s;yield a?i.mapResultRow(a,s,u):s}}finally{h.off("data",p),l(y)&&n.end()}}}class a extends t.MySqlSession{constructor(t,s,r={}){super(s),this.client=t,this.options=r,this.logger=r.logger??new e.NoopLogger}prepareQuery(e,t){return new n(this.client,e.sql,e.params,this.logger,t)}async query(e,t){this.logger.logQuery(e,t);return await this.client.query({sql:e,values:t,rowsAsArray:!0,typeCast:function(e,t){return"TIMESTAMP"===e.type||"DATETIME"===e.type||"DATE"===e.type?e.string():t()}})}all(e){const t=this.dialect.sqlToQuery(e);return this.logger.logQuery(t.sql,t.params),this.client.execute(t.sql,t.params).then((e=>e[0]))}async transaction(e,t){const s=l(this.client)?new a(await this.client.getConnection(),this.dialect,this.options):this,i=new o(this.dialect,s);if(t){const e=this.getSetTransactionSQL(t);e&&await i.execute(e);const s=this.getStartTransactionSQL(t);await(s?i.execute(s):i.execute(r.sql`begin`))}else await i.execute(r.sql`begin`);try{const t=await e(i);return await i.execute(r.sql`commit`),t}catch(e){throw await i.execute(r.sql`rollback`),e}finally{l(this.client)&&s.client.release()}}}class o extends t.MySqlTransaction{async transaction(e){const t=`sp${this.nestedIndex+1}`,s=new o(this.dialect,this.session,this.nestedIndex+1);await s.execute(r.sql.raw(`savepoint ${t}`));try{const i=await e(s);return await s.execute(r.sql.raw(`release savepoint ${t}`)),i}catch(e){throw await s.execute(r.sql.raw(`rollback to savepoint ${t}`)),e}}}function l(e){return"getConnection"in e}class c{constructor(e,t,s={}){this.client=e,this.dialect=t,this.options=s}createSession(){return new a(this.client,this.dialect,{logger:this.options.logger})}}exports.MySqlDatabase=t.MySqlDatabase,exports.MySql2Driver=c,exports.MySql2PreparedQuery=n,exports.MySql2Session=a,exports.MySql2Transaction=o,exports.drizzle=function(s,r={}){const i=new t.MySqlDialect;let n;!0===r.logger?n=new e.DefaultLogger:!1!==r.logger&&(n=r.logger),function(e){return"function"==typeof e.promise}(s)&&(s=s.promise());const a=new c(s,i,{logger:n}).createSession();return new t.MySqlDatabase(i,a)};
//# sourceMappingURL=index.cjs.map
