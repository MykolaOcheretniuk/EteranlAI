"use strict";var e=require("pg"),t=require("../logger-04bad527.cjs"),s=require("../session-ef1ef979.cjs"),r=require("../index-59b7992d.cjs"),i=require("../utils-9d882195.cjs");require("../query-promise-2c5b43ab.cjs"),require("../query-builder-2f2e8229.cjs"),require("../column-builder-b48639f3.cjs");const{Pool:n}=e;class a extends s.PreparedQuery{constructor(e,t,s,r,i,n){super(),this.client=e,this.params=s,this.logger=r,this.fields=i,this.rawQuery={name:n,text:t},this.query={name:n,text:t,rowMode:"array"}}execute(e={}){const t=r.fillPlaceholders(this.params,e);this.logger.logQuery(this.rawQuery.text,t);const{fields:s,rawQuery:n,client:a,query:o,joinsNotNullableMap:l}=this;if(!s)return a.query(n,t);return a.query(o,t).then((e=>e.rows.map((e=>i.mapResultRow(s,e,l)))))}all(e={}){const t=r.fillPlaceholders(this.params,e);return this.logger.logQuery(this.rawQuery.text,t),this.client.query(this.rawQuery,t).then((e=>e.rows))}values(e={}){const t=r.fillPlaceholders(this.params,e);return this.logger.logQuery(this.rawQuery.text,t),this.client.query(this.query,t).then((e=>e.rows))}}class o extends s.PgSession{constructor(e,s,r={}){super(s),this.client=e,this.options=r,this.logger=r.logger??new t.NoopLogger}prepareQuery(e,t,s){return new a(this.client,e.sql,e.params,this.logger,t,s)}async query(e,t){this.logger.logQuery(e,t);return await this.client.query({rowMode:"array",text:e,values:t})}async queryObjects(e,t){return this.client.query(e,t)}async transaction(e,t){const s=this.client instanceof n?new o(await this.client.connect(),this.dialect,this.options):this,i=new l(this.dialect,s);await i.execute(r.sql`begin${t?r.sql` ${i.getTransactionConfigSQL(t)}`:void 0}`);try{const t=await e(i);return await i.execute(r.sql`commit`),t}catch(e){throw await i.execute(r.sql`rollback`),e}finally{this.client instanceof n&&s.client.release()}}}class l extends s.PgTransaction{async transaction(e){const t=`sp${this.nestedIndex+1}`,s=new l(this.dialect,this.session,this.nestedIndex+1);await s.execute(r.sql.raw(`savepoint ${t}`));try{const i=await e(s);return await s.execute(r.sql.raw(`release savepoint ${t}`)),i}catch(e){throw await s.execute(r.sql.raw(`rollback to savepoint ${t}`)),e}}}const{types:c}=e;class u{constructor(e,t,s={}){this.client=e,this.dialect=t,this.options=s,this.initMappers()}createSession(){return new o(this.client,this.dialect,{logger:this.options.logger})}initMappers(){c.setTypeParser(c.builtins.TIMESTAMPTZ,(e=>e)),c.setTypeParser(c.builtins.TIMESTAMP,(e=>e)),c.setTypeParser(c.builtins.DATE,(e=>e))}}exports.NodePgDriver=u,exports.NodePgPreparedQuery=a,exports.NodePgSession=o,exports.NodePgTransaction=l,exports.drizzle=function(e,r={}){const i=new s.PgDialect;let n;!0===r.logger?n=new t.DefaultLogger:!1!==r.logger&&(n=r.logger);const a=new u(e,i,{logger:n}).createSession();return new s.PgDatabase(i,a)};
//# sourceMappingURL=index.cjs.map
