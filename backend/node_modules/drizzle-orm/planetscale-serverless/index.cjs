"use strict";var e=require("../logger-04bad527.cjs"),t=require("../session-e6db6732.cjs"),s=require("../index-59b7992d.cjs"),r=require("../utils-9d882195.cjs");require("../query-promise-2c5b43ab.cjs"),require("../column-builder-b48639f3.cjs"),require("../query-builder-2f2e8229.cjs");class i extends t.PreparedQuery{constructor(e,t,s,r,i){super(),this.client=e,this.queryString=t,this.params=s,this.logger=r,this.fields=i,this.rawQuery={as:"object"},this.query={as:"array"}}async execute(e={}){const t=s.fillPlaceholders(this.params,e);this.logger.logQuery(this.queryString,t);const{fields:i,client:a,queryString:n,rawQuery:l,query:o,joinsNotNullableMap:c}=this;if(!i)return a.execute(n,t,l);return a.execute(n,t,o).then((e=>e.rows.map((e=>r.mapResultRow(i,e,c)))))}iterator(e){throw new Error("Streaming is not supported by the PlanetScale Serverless driver")}}class a extends t.MySqlSession{constructor(t,s,r,i={}){super(s),this.baseClient=t,this.options=i,this.client=r??t,this.logger=i.logger??new e.NoopLogger}prepareQuery(e,t){return new i(this.client,e.sql,e.params,this.logger,t)}async query(e,t){return this.logger.logQuery(e,t),await this.client.execute(e,t,{as:"array"})}async queryObjects(e,t){return this.client.execute(e,t,{as:"object"})}all(e){const t=this.dialect.sqlToQuery(e);return this.logger.logQuery(t.sql,t.params),this.client.execute(t.sql,t.params,{as:"object"}).then((e=>e.rows))}transaction(e){return this.baseClient.transaction((t=>{const s=new a(this.baseClient,this.dialect,t,this.options),r=new n(this.dialect,s);return e(r)}))}}class n extends t.MySqlTransaction{async transaction(e){const t=`sp${this.nestedIndex+1}`,r=new n(this.dialect,this.session,this.nestedIndex+1);await r.execute(s.sql.raw(`savepoint ${t}`));try{const i=await e(r);return await r.execute(s.sql.raw(`release savepoint ${t}`)),i}catch(e){throw await r.execute(s.sql.raw(`rollback to savepoint ${t}`)),e}}}class l{constructor(e,t,s={}){this.client=e,this.dialect=t,this.options=s}createSession(){return new a(this.client,this.dialect,void 0,{logger:this.options.logger})}}exports.PlanetScalePreparedQuery=i,exports.PlanetScaleTransaction=n,exports.PlanetscaleDriver=l,exports.PlanetscaleSession=a,exports.drizzle=function(s,r={}){const i=new t.MySqlDialect;let a;!0===r.logger?a=new e.DefaultLogger:!1!==r.logger&&(a=r.logger);const n=new l(s,i,{logger:a}).createSession();return new t.MySqlDatabase(i,n)};
//# sourceMappingURL=index.cjs.map
