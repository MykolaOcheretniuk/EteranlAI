import{N as s,D as t}from"../logger-2598bf05.mjs";import{S as r,a as e,P as i,B as n,c as a}from"../session-b977ce56.mjs";import{s as o,k as l}from"../index-b71998f1.mjs";import{m as c}from"../utils-e6870670.mjs";import"../query-builder-2fcde2f0.mjs";class h extends r{constructor(t,r,e={}){super(r),this.client=t,this.logger=e.logger??new s}prepareQuery(s,t){return new u(this.client,s.sql,s.params,this.logger,t)}async transaction(s,t){const r=new g(this.dialect,this);await this.run(o.raw("begin"+(t?.behavior?" "+t.behavior:"")));try{const t=await s(r);return await this.run(o`commit`),t}catch(s){throw await this.run(o`rollback`),s}}}class g extends e{async transaction(s){const t=`sp${this.nestedIndex}`,r=new g(this.dialect,this.session,this.nestedIndex+1);await this.session.run(o.raw(`savepoint ${t}`));try{const e=await s(r);return await this.session.run(o.raw(`release savepoint ${t}`)),e}catch(s){throw await this.session.run(o.raw(`rollback to savepoint ${t}`)),s}}}class u extends i{constructor(s,t,r,e,i){super(),this.client=s,this.queryString=t,this.params=r,this.logger=e,this.fields=i}async run(s){const t=l(this.params,s??{});return this.logger.logQuery(this.queryString,t),await this.client(this.queryString,t,"run")}async all(s){const{fields:t,queryString:r,logger:e,joinsNotNullableMap:i}=this,n=l(this.params,s??{});e.logQuery(r,n);const a=this.client(r,n,"all");return t?a.then((s=>s.rows.map((s=>c(t,s,i))))):this.client(r,n,"all").then((({rows:s})=>s))}async get(s){const{fields:t,queryString:r,logger:e,joinsNotNullableMap:i}=this,n=l(this.params,s??{});e.logQuery(r,n);const a=await this.client(r,n,"get");return t?void 0===a.rows?c(t,[],i):c(t,a.rows,i):a.rows}async values(s){const t=l(this.params,s??{});this.logger.logQuery(this.queryString,t);return(await this.client(this.queryString,t,"values")).rows}}function w(s,r={}){const e=new a;let i;!0===r.logger?i=new t:!1!==r.logger&&(i=r.logger);const o=new h(s,e,{logger:i});return new n(e,o)}export{u as PreparedQuery,g as SQLiteProxyTransaction,h as SQLiteRemoteSession,w as drizzle};
//# sourceMappingURL=index.mjs.map
