import{a as e,g as t,o as s,b as i,c as n,T as r}from"./utils-e6870670.mjs";import{T as o,C as a,e as l,P as c,s as h,o as u,V as f,n as d,u as g,m as p,l as m,v as y,W as b}from"./index-b71998f1.mjs";import{Q as w}from"./query-promise-a65edd44.mjs";import{C as $}from"./column-builder-592f0191.mjs";import{T as v}from"./query-builder-2fcde2f0.mjs";var S,q;const x=Symbol("InlineForeignKeys"),j=Symbol("ExtraConfigBuilder");class Q extends o{constructor(){super(...arguments),this[S]=[],this[q]=void 0}}function N(e,t,s,i,n=e){const r=new Q(e,i,n),a=Object.fromEntries(Object.entries(t).map((([e,t])=>{const s=t.build(r);return r[x].push(...t.buildForeignKeys(s,r)),[e,s]}))),l=Object.assign(r,a);return l[o.Symbol.Columns]=a,s&&(l[Q.Symbol.ExtraConfigBuilder]=s),l}o.Symbol.Columns,S=x,q=j,Q.Symbol=Object.assign({},o.Symbol,{InlineForeignKeys:x,ExtraConfigBuilder:j});const L=(e,t,s)=>N(e,t,s,void 0,e);function B(e){return(t,s,i)=>N(e(t),s,i,void 0,t)}class C{constructor(e,t){this.reference=()=>{const{columns:t,foreignColumns:s}=e();return{columns:t,foreignTable:s[0].table,foreignColumns:s}},t&&(this._onUpdate=t.onUpdate,this._onDelete=t.onDelete)}onUpdate(e){return this._onUpdate=e,this}onDelete(e){return this._onDelete=e,this}build(e){return new A(e,this)}}class A{constructor(e,t){this.table=e,this.reference=t.reference,this.onUpdate=t._onUpdate,this.onDelete=t._onDelete}getName(){const{columns:e,foreignColumns:t}=this.reference(),s=e.map((e=>e.name)),i=t.map((e=>e.name));return`${[this.table[Q.Symbol.Name],...s,t[0].table[Q.Symbol.Name],...i].join("_")}_fk`}}function T(e){return new C((function(){const{columns:t,foreignColumns:s}=e;return{columns:t,foreignColumns:s}}))}class O extends ${constructor(){super(...arguments),this.foreignKeyConfigs=[]}references(e,t={}){return this.foreignKeyConfigs.push({ref:e,actions:t}),this}buildForeignKeys(e,t){return this.foreignKeyConfigs.map((({ref:s,actions:i})=>((s,i)=>{const n=new C((()=>{const t=s();return{columns:[e],foreignColumns:[t]}}));return i.onUpdate&&n.onUpdate(i.onUpdate),i.onDelete&&n.onDelete(i.onDelete),n.build(t)})(s,i)))}}class P extends a{}class k extends O{constructor(e){super(e),this.config.autoIncrement=!1}autoincrement(){return this.config.autoIncrement=!0,this}}class I extends P{constructor(){super(...arguments),this.autoIncrement=this.config.autoIncrement}}class M extends w{constructor(e,t,s){super(),this.table=e,this.session=t,this.dialect=s,this.execute=e=>this.prepare().execute(e),this.createIterator=()=>{const e=this;return async function*(t){yield*e.prepare().iterator(t)}},this.iterator=this.createIterator(),this.config={table:e}}where(e){return this.config.where=e,this}getSQL(){return this.dialect.buildDeleteQuery(this.config)}toSQL(){const{typings:e,...t}=this.dialect.sqlToQuery(this.getSQL());return t}prepare(){return this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),this.config.returning)}}class _{constructor(e,t,s){this.table=e,this.session=t,this.dialect=s,this.shouldIgnore=!1}ignore(){return this.shouldIgnore=!0,this}values(e){if(0===(e=Array.isArray(e)?e:[e]).length)throw new Error("values() must be called with at least one value");const t=e.map((e=>{const t={},s=this.table[o.Symbol.Columns];for(const i of Object.keys(e)){const n=e[i];t[i]=n instanceof l?n:new c(n,s[i])}return t}));return new D(this.table,t,this.shouldIgnore,this.session,this.dialect)}}class D extends w{constructor(e,t,s,i,n){super(),this.session=i,this.dialect=n,this.execute=e=>this.prepare().execute(e),this.createIterator=()=>{const e=this;return async function*(t){yield*e.prepare().iterator(t)}},this.iterator=this.createIterator(),this.config={table:e,values:t,ignore:s}}onDuplicateKeyUpdate(t){const s=this.dialect.buildUpdateSet(this.config.table,e(this.config.table,t.set));return this.config.onConflict=h`update ${s}`,this}getSQL(){return this.dialect.buildInsertQuery(this.config)}toSQL(){const{typings:e,...t}=this.dialect.sqlToQuery(this.getSQL());return t}prepare(){return this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),void 0)}}class F{constructor(e,t){this.name=e,this.schema=t,this.config={}}algorithm(e){return this.config.algorithm=e,this}definer(e){return this.config.definer=e,this}sqlSecurity(e){return this.config.sqlSecurity=e,this}withCheckOption(e){return this.config.withCheckOption=e??"cascaded",this}}class U extends F{as(e){"function"==typeof e&&(e=e(new X));const t=new u({alias:this.name,sqlBehavior:"error",sqlAliasedBehavior:"alias",replaceOriginalName:!0}),s=new Proxy(e.getSelectedFields(),t);return new Proxy(new z({mysqlConfig:this.config,config:{name:this.name,schema:this.schema,selectedFields:s,query:e.getSQL().inlineParams()}}),t)}}class E extends F{constructor(e,s,i){super(e,i),this.columns=t(L(e,s))}existing(){return new Proxy(new z({mysqlConfig:void 0,config:{name:this.name,schema:this.schema,selectedFields:this.columns,query:void 0}}),new u({alias:this.name,sqlBehavior:"error",sqlAliasedBehavior:"alias",replaceOriginalName:!0}))}as(e){return new Proxy(new z({mysqlConfig:this.config,config:{name:this.name,schema:this.schema,selectedFields:this.columns,query:e.inlineParams()}}),new u({alias:this.name,sqlBehavior:"error",sqlAliasedBehavior:"alias",replaceOriginalName:!0}))}}class J extends f{}const K=Symbol("MySqlViewConfig");class z extends J{constructor({mysqlConfig:e,config:t}){super(t),this[K]=e}}function V(e,t,s){return t?new E(e,t,s):new U(e,s)}function W(e,t){return V(e,t,void 0)}class Y{async migrate(e,t,s){const i=s.migrationsTable??"__drizzle_migrations",n=h`
			create table if not exists ${d(i)} (
				id serial primary key,
				hash text not null,
				created_at bigint
			)
		`;await t.execute(n);const r=(await t.all(h`select id, hash, created_at from ${d(i)} order by created_at desc limit 1`))[0];await t.transaction((async t=>{for(const s of e)if(!r||Number(r.created_at)<s.folderMillis){for(const e of s.sql)await t.execute(h.raw(e));await t.execute(h`insert into ${d(i)} (\`hash\`, \`created_at\`) values(${s.hash}, ${s.folderMillis})`)}}))}escapeName(e){return`\`${e}\``}escapeParam(e){return"?"}escapeString(e){return`'${e.replace(/'/g,"''")}'`}buildDeleteQuery({table:e,where:t,returning:s}){const i=s?h` returning ${this.buildSelection(s,{isSingleTable:!0})}`:void 0,n=t?h` where ${t}`:void 0;return h`delete from ${e}${n}${i}`}buildUpdateSet(e,t){const s=Object.entries(t),i=s.length;return h.fromList(s.flatMap((([t,s],n)=>{const r=e[o.Symbol.Columns][t],a=h`${d(r.name)} = ${s}`;return n<i-1?[a,h.raw(", ")]:[a]})))}buildUpdateQuery({table:e,set:t,where:s,returning:i}){const n=this.buildUpdateSet(e,t),r=i?h` returning ${this.buildSelection(i,{isSingleTable:!0})}`:void 0,o=s?h` where ${s}`:void 0;return h`update ${e} set ${n}${o}${r}`}buildSelection(e,{isSingleTable:t=!1}={}){const s=e.length,i=e.flatMap((({field:e},i)=>{const n=[];if(e instanceof l.Aliased&&e.isSelectionField)n.push(d(e.fieldAlias));else if(e instanceof l.Aliased||e instanceof l){const s=e instanceof l.Aliased?e.sql:e;t?n.push(new l(s.queryChunks.map((e=>e instanceof P?d(e.name):e)))):n.push(s),e instanceof l.Aliased&&n.push(h` as ${d(e.fieldAlias)}`)}else e instanceof a&&(t?n.push(d(e.name)):n.push(e));return i<s-1&&n.push(h`, `),n}));return h.fromList(i)}buildSelectQuery({withList:e,fields:t,where:i,having:n,table:r,joins:c,orderBy:u,groupBy:b,limit:w,offset:$,lockingClause:v}){const S=s(t);for(const e of S)if(e.field instanceof a&&g(e.field.table)!==(r instanceof p?r[m].alias:r instanceof J?r[y].name:r instanceof l?void 0:g(r))&&!(e=>c.some((({alias:t})=>t===g(e))))(e.field.table)){const t=g(e.field.table);throw new Error(`Your "${e.path.join("->")}" field references a column "${t}"."${e.field.name}", but the table "${t}" is not part of the query! Did you forget to join it?`)}const q=0===c.length;let x;if(e.length){const t=[h`with `];for(const[s,i]of e.entries())t.push(h`${d(i[m].alias)} as (${i[m].sql})`),s<e.length-1&&t.push(h`, `);t.push(h` `),x=h.fromList(t)}const j=this.buildSelection(S,{isSingleTable:q}),N=r instanceof o&&r[o.Symbol.OriginalName]!==r[o.Symbol.Name]?h`${d(r[o.Symbol.OriginalName])} ${d(r[o.Symbol.Name])}`:r,L=[];for(const[e,t]of c.entries()){0===e&&L.push(h` `);const s=t.table;if(s instanceof Q){const e=s[Q.Symbol.Name],i=s[Q.Symbol.Schema],n=s[Q.Symbol.OriginalName],r=e===n?void 0:t.alias;L.push(h`${h.raw(t.joinType)} join ${i?h`${d(i)}.`:void 0}${d(n)}${r&&h` ${d(r)}`} on ${t.on}`)}else if(s instanceof f){const e=s[y].name,i=s[y].schema,n=s[y].originalName,r=e===n?void 0:t.alias;L.push(h`${h.raw(t.joinType)} join ${i?h`${d(i)}.`:void 0}${d(n)}${r&&h` ${d(r)}`} on ${t.on}`)}else L.push(h`${h.raw(t.joinType)} join ${s} on ${t.on}`);e<c.length-1&&L.push(h` `)}const B=h.fromList(L),C=i?h` where ${i}`:void 0,A=n?h` having ${n}`:void 0,T=[];for(const[e,t]of u.entries())T.push(t),e<u.length-1&&T.push(h`, `);const O=T.length>0?h` order by ${h.fromList(T)}`:void 0,P=[];for(const[e,t]of b.entries())P.push(t),e<b.length-1&&P.push(h`, `);const k=P.length>0?h` group by ${h.fromList(P)}`:void 0,I=w?h` limit ${w}`:void 0,M=$?h` offset ${$}`:void 0;let _;if(v){const{config:e,strength:t}=v;_=h` for ${h.raw(t)}`,e.noWait?_.append(h` no wait`):e.skipLocked&&_.append(h` skip locked`)}return h`${x}select ${j} from ${N}${B}${C}${k}${A}${O}${I}${M}${_}`}buildInsertQuery({table:e,values:t,ignore:s,onConflict:i}){const n=1===t.length,r=[],a=e[o.Symbol.Columns],l=n?Object.keys(t[0]).map((e=>[e,a[e]])):Object.entries(a),u=l.map((([,e])=>d(e.name)));for(const[e,s]of t.entries()){const i=[];for(const[e]of l){const t=s[e];void 0===t||t instanceof c&&void 0===t.value?i.push(h`default`):i.push(t)}r.push(i),e<t.length-1&&r.push(h`, `)}const f=h.fromList(r),g=s?h` ignore`:void 0,p=i?h` on duplicate key ${i}`:void 0;return h`insert${g} into ${e} ${u} values ${f}${p}`}sqlToQuery(e){return e.toQuery({escapeName:this.escapeName,escapeParam:this.escapeParam,escapeString:this.escapeString})}}class G{constructor(e,t,s,i=[]){this.fields=e,this.session=t,this.dialect=s,this.withList=i}from(e){const s=!!this.fields;let i;return i=this.fields?this.fields:e instanceof p?Object.fromEntries(Object.keys(e[m].selection).map((t=>[t,e[t]]))):e instanceof J?e[y].selectedFields:e instanceof l?{}:t(e),new R(e,i,s,this.session,this.dialect,this.withList)}}class H extends v{constructor(e,t,s,i,r,o){super(),this.isPartialSelect=s,this.session=i,this.dialect=r,this.leftJoin=this.createJoin("left"),this.rightJoin=this.createJoin("right"),this.innerJoin=this.createJoin("inner"),this.fullJoin=this.createJoin("full"),this.config={withList:o,table:e,fields:{...t},joins:[],orderBy:[],groupBy:[]},this._={selectedFields:t},this.tableName=n(e),this.joinsNotNullableMap="string"==typeof this.tableName?{[this.tableName]:!0}:{}}createJoin(e){return(t,s)=>{const i=this.tableName,r=n(t);if("string"==typeof r&&this.config.joins.some((e=>e.alias===r)))throw new Error(`Alias "${r}" is already used in this query`);if(!(this.isPartialSelect||(1===Object.keys(this.joinsNotNullableMap).length&&"string"==typeof i&&(this.config.fields={[i]:this.config.fields}),"string"!=typeof r||t instanceof l))){const e=t instanceof p?t[m].selection:t instanceof f?t[y].selectedFields:t[o.Symbol.Columns];this.config.fields[r]=e}if("function"==typeof s&&(s=s(new Proxy(this.config.fields,new u({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.joins.push({on:s,table:t,joinType:e,alias:r}),"string"==typeof r)switch(e){case"left":this.joinsNotNullableMap[r]=!1;break;case"right":this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map((([e])=>[e,!1]))),this.joinsNotNullableMap[r]=!0;break;case"inner":this.joinsNotNullableMap[r]=!0;break;case"full":this.joinsNotNullableMap=Object.fromEntries(Object.entries(this.joinsNotNullableMap).map((([e])=>[e,!1]))),this.joinsNotNullableMap[r]=!1}return this}}where(e){return"function"==typeof e&&(e=e(new Proxy(this.config.fields,new u({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.where=e,this}having(e){return"function"==typeof e&&(e=e(new Proxy(this.config.fields,new u({sqlAliasedBehavior:"sql",sqlBehavior:"sql"})))),this.config.having=e,this}groupBy(...e){if("function"==typeof e[0]){const t=e[0](new Proxy(this.config.fields,new u({sqlAliasedBehavior:"alias",sqlBehavior:"sql"})));this.config.groupBy=Array.isArray(t)?t:[t]}else this.config.groupBy=e;return this}orderBy(...e){if("function"==typeof e[0]){const t=e[0](new Proxy(this.config.fields,new u({sqlAliasedBehavior:"alias",sqlBehavior:"sql"})));this.config.orderBy=Array.isArray(t)?t:[t]}else this.config.orderBy=e;return this}limit(e){return this.config.limit=e,this}offset(e){return this.config.offset=e,this}for(e,t={}){return this.config.lockingClause={strength:e,config:t},this}getSQL(){return this.dialect.buildSelectQuery(this.config)}toSQL(){const{typings:e,...t}=this.dialect.sqlToQuery(this.getSQL());return t}as(e){return new Proxy(new p(this.getSQL(),this.config.fields,e),new u({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"}))}}class R extends H{constructor(){super(...arguments),this.execute=e=>this.prepare().execute(e),this.createIterator=()=>{const e=this;return async function*(t){yield*e.prepare().iterator(t)}},this.iterator=this.createIterator()}prepare(){if(!this.session)throw new Error("Cannot execute a query on a query builder. Please use a database instance instead.");const e=s(this.config.fields),t=this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),e);return t.joinsNotNullableMap=this.joinsNotNullableMap,t}}i(R,[w]);class X{$with(e){const t=this;return{as:s=>("function"==typeof s&&(s=s(t)),new Proxy(new b(s.getSQL(),s.getSelectedFields(),e,!0),new u({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"})))}}with(...e){const t=this;return{select:function(s){return new G(s??void 0,void 0,t.getDialect(),e)}}}select(e){return new G(e??void 0,void 0,this.getDialect())}getDialect(){return this.dialect||(this.dialect=new Y),this.dialect}}class Z{constructor(e,t,s){this.table=e,this.session=t,this.dialect=s}set(t){return new ee(this.table,e(this.table,t),this.session,this.dialect)}}class ee extends w{constructor(e,t,s,i){super(),this.session=s,this.dialect=i,this.execute=e=>this.prepare().execute(e),this.createIterator=()=>{const e=this;return async function*(t){yield*e.prepare().iterator(t)}},this.iterator=this.createIterator(),this.config={set:t,table:e}}where(e){return this.config.where=e,this}getSQL(){return this.dialect.buildUpdateQuery(this.config)}toSQL(){const{typings:e,...t}=this.dialect.sqlToQuery(this.getSQL());return t}prepare(){return this.session.prepareQuery(this.dialect.sqlToQuery(this.getSQL()),this.config.returning)}}class te{constructor(e,t){this.dialect=e,this.session=t}$with(e){return{as:t=>("function"==typeof t&&(t=t(new X)),new Proxy(new b(t.getSQL(),t.getSelectedFields(),e,!0),new u({alias:e,sqlAliasedBehavior:"alias",sqlBehavior:"error"})))}}with(...e){const t=this;return{select:function(s){return new G(s??void 0,t.session,t.dialect,e)}}}select(e){return new G(e??void 0,this.session,this.dialect)}update(e){return new Z(e,this.session,this.dialect)}insert(e){return new _(e,this.session,this.dialect)}delete(e){return new M(e,this.session,this.dialect)}execute(e){return this.session.execute(e.getSQL())}transaction(e,t){return this.session.transaction(e,t)}}class se{}class ie{constructor(e){this.dialect=e}execute(e){return this.prepareQuery(this.dialect.sqlToQuery(e),void 0).execute()}getSetTransactionSQL(e){const t=[];return e.isolationLevel&&t.push(`isolation level ${e.isolationLevel}`),t.length?h.fromList(["set transaction ",t.join(" ")]):void 0}getStartTransactionSQL(e){const t=[];return e.withConsistentSnapshot&&t.push("with consistent snapshot"),e.accessMode&&t.push(e.accessMode),t.length?h.fromList(["start transaction ",t.join(" ")]):void 0}}class ne extends te{constructor(e,t,s=0){super(e,t),this.nestedIndex=s}rollback(){throw new r}}export{z as A,W as B,j as E,C as F,x as I,k as M,se as P,X as Q,F as V,I as a,O as b,P as c,Q as d,V as e,K as f,te as g,Y as h,A as i,T as j,M as k,_ as l,N as m,D as n,G as o,H as p,R as q,Z as r,ee as s,ie as t,ne as u,L as v,B as w,U as x,E as y,J as z};
//# sourceMappingURL=session-8a621f09.mjs.map
